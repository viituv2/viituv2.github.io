<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galvanur RPG - World Map</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
            overflow-x: auto;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(255,255,255,0.3);
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .control-group label {
            font-size: 0.9em;
            color: #ccc;
        }

        select, input, button {
            padding: 8px 12px;
            border: 2px solid #4ecdc4;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }

        select option {
            background: #1a1a2e;
            color: white;
        }

        button {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #4ecdc4;
            color: #1a1a2e;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.3);
        }

        .info-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #4ecdc4;
            max-width: 300px;
            backdrop-filter: blur(10px);
            z-index: 1000;
        }

        .info-panel h3 {
            margin: 0 0 10px 0;
            color: #4ecdc4;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
        }

        #map-container {
            width: 100%;
            height: 800px;
            border: 2px solid #4ecdc4;
            border-radius: 15px;
            background: radial-gradient(circle at center, rgba(78, 205, 196, 0.1), rgba(26, 26, 46, 0.8));
            overflow: hidden;
            position: relative;
        }

        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node:hover {
            stroke-width: 3px !important;
            filter: drop-shadow(0 0 10px currentColor);
        }

        .link {
            stroke: rgba(255,255,255,0.3);
            stroke-width: 1;
            transition: all 0.3s ease;
        }

        .link.highlighted {
            stroke: #4ecdc4;
            stroke-width: 2;
            filter: drop-shadow(0 0 5px #4ecdc4);
        }

        .node-label {
            fill: white;
            font-size: 10px;
            text-anchor: middle;
            pointer-events: none;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #4ecdc4;
        }

        .zoom-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>GALVANUR RPG - WORLD MAP</h1>
            <p>Interaktive Visualisierung aller 85 Gebiete mit allen Verbindungen // hat dewitt ganz feini gemacht</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>Layout Typ:</label>
                <select id="layoutType">
                    <option value="force">Force Layout (Automatisch)</option>
                    <option value="circular">Kreisförmig</option>
                    <option value="hierarchical">Hierarchisch (Danger Level)</option>
                </select>
            </div>
            <div class="control-group">
                <label>Danger Level Filter:</label>
                <select id="dangerFilter">
                    <option value="all">Alle Level</option>
                    <option value="low">Level 1-10 (Anfänger)</option>
                    <option value="mid">Level 11-30 (Fortgeschritten)</option>
                    <option value="high">Level 31-50 (Experten)</option>
                </select>
            </div>
            <div class="control-group">
                <label>Knotengröße:</label>
                <input type="range" id="nodeSize" min="5" max="20" value="8">
            </div>
            <div class="control-group">
                <label>Aktionen:</label>
                <button onclick="resetZoom()">Zoom Reset</button>
                <button onclick="centerMap()">Zentrieren</button>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #ff6b6b;"></div>
                <span>Danger 1-10</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ffd93d;"></div>
                <span>Danger 11-20</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #6bcf7f;"></div>
                <span>Danger 21-30</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #4d96ff;"></div>
                <span>Danger 31-40</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #9c88ff;"></div>
                <span>Danger 41-50</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: gold; border: 2px solid white;"></div>
                <span>Fast Travel</span>
            </div>
        </div>

        <div id="map-container">
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomIn()">+</button>
                <button class="zoom-btn" onclick="zoomOut()">-</button>
            </div>
        </div>

        <div class="info-panel" id="infoPanel" style="display: none;">
            <h3 id="infoTitle">Gebiet Information</h3>
            <p id="infoContent">Bewege die Maus über ein Gebiet für Details</p>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-number">85</div>
                <div>Gebiete Total</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">50</div>
                <div>Max Danger Level</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="connectionsCount">0</div>
                <div>Verbindungen</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">7</div>
                <div>Fast Travel Punkte</div>
            </div>
        </div>
    </div>

    <script>
        // World Data aus deiner Datei
        const worldData = {
            nodes: [
                // Danger Level 1
                {id: "AREA_002", name: "Emerald Meadows", danger: 1, fastTravel: false},
                {id: "AREA_004", name: "Merchant's Quarter", danger: 1, fastTravel: false},
                {id: "AREA_001", name: "Valoria Capital", danger: 1, fastTravel: true, capital: true},
                {id: "AREA_003", name: "Whispering Woods", danger: 1, fastTravel: false},
                
                // Danger Level 2
                {id: "AREA_008", name: "Catfolk Rooftops", danger: 2, fastTravel: false},
                {id: "AREA_006", name: "Goblin Caves", danger: 2, fastTravel: false},
                {id: "AREA_012", name: "Rabbitkin Warrens", danger: 2, fastTravel: false},
                {id: "AREA_080", name: "Silverleaf Citadel", danger: 2, fastTravel: true},
                {id: "AREA_005", name: "Windswept Hills", danger: 2, fastTravel: false},
                
                // Danger Level 3
                {id: "AREA_010", name: "Pack Territories", danger: 3, fastTravel: false},
                {id: "AREA_007", name: "Silverleaf Groves", danger: 3, fastTravel: false},
                {id: "AREA_011", name: "Trickster Village", danger: 3, fastTravel: false},
                
                // Danger Level 4
                {id: "AREA_084", name: "Great Pack Gathering", danger: 4, fastTravel: true},
                {id: "AREA_009", name: "Iron Mountains", danger: 4, fastTravel: true},
                
                // Higher Danger Levels (5-50)
                {id: "AREA_013", name: "Badlands Frontier", danger: 5, fastTravel: false},
                {id: "AREA_014", name: "Shadow Depths", danger: 6, fastTravel: false},
                {id: "AREA_021", name: "Crystal Caverns", danger: 7, fastTravel: false},
                {id: "AREA_015", name: "Dragonspire Peaks", danger: 8, fastTravel: false},
                {id: "AREA_018", name: "Bridge Guardian Valley", danger: 9, fastTravel: false},
                {id: "AREA_083", name: "Coral Palace", danger: 9, fastTravel: true},
                {id: "AREA_016", name: "Titan Cliffs", danger: 10, fastTravel: false},
                {id: "AREA_022", name: "Volcanic Ridges", danger: 11, fastTravel: false},
                {id: "AREA_017", name: "Sky Citadel", danger: 12, fastTravel: true},
                {id: "AREA_023", name: "Frozen Tundra", danger: 13, fastTravel: false},
                {id: "AREA_025", name: "Coral Reef City", danger: 14, fastTravel: true},
                {id: "AREA_019", name: "Infernal Borderlands", danger: 15, fastTravel: false},
                {id: "AREA_081", name: "Iron Mountain Stronghold", danger: 15, fastTravel: true},
                {id: "AREA_082", name: "Golden Oasis", danger: 16, fastTravel: true},
                {id: "AREA_024", name: "Primordial Jungle", danger: 16, fastTravel: false},
                {id: "AREA_026", name: "Moonlit Desert", danger: 17, fastTravel: false},
                {id: "AREA_020", name: "Celestial Sanctuary", danger: 18, fastTravel: false},
                {id: "AREA_037", name: "Ancient Crossroads", danger: 19, fastTravel: false},
                {id: "AREA_085", name: "Mystic Spire", danger: 20, fastTravel: true},
                {id: "AREA_027", name: "Nightmare Swamps", danger: 20, fastTravel: false},
                
                // Ultra High Level Areas (21-50)
                {id: "AREA_043", name: "Resonance Chambers", danger: 21, fastTravel: false},
                {id: "AREA_035", name: "Storm Nexus", danger: 22, fastTravel: false},
                {id: "AREA_038", name: "Memory Pools", danger: 23, fastTravel: false},
                {id: "AREA_044", name: "Prismatic Caverns", danger: 24, fastTravel: false},
                {id: "AREA_028", name: "Astral Observatory", danger: 25, fastTravel: false},
                {id: "AREA_036", name: "Skyward Spires", danger: 26, fastTravel: false},
                {id: "AREA_045", name: "Molten Core", danger: 27, fastTravel: false},
                {id: "AREA_039", name: "Planar Rift Canyon", danger: 28, fastTravel: false},
                {id: "AREA_046", name: "Phoenix Nests", danger: 29, fastTravel: false},
                {id: "AREA_029", name: "Elemental Confluence", danger: 30, fastTravel: false},
                {id: "AREA_047", name: "Eternal Winter", danger: 31, fastTravel: false},
                {id: "AREA_040", name: "Soul Forge Depths", danger: 32, fastTravel: false},
                {id: "AREA_048", name: "Aurora Peaks", danger: 33, fastTravel: false},
                {id: "AREA_049", name: "First Garden", danger: 34, fastTravel: false},
                {id: "AREA_030", name: "Time Fracture Zone", danger: 35, fastTravel: false},
                {id: "AREA_041", name: "Celestial Throne Room", danger: 36, fastTravel: false},
                {id: "AREA_050", name: "Titan Graveyard", danger: 37, fastTravel: false},
                {id: "AREA_042", name: "Harmony Nexus", danger: 38, fastTravel: false},
                {id: "AREA_051", name: "Abyssal Trenches", danger: 39, fastTravel: false},
                {id: "AREA_031", name: "Void Nexus", danger: 40, fastTravel: false},
                {id: "AREA_069", name: "Wisdom Wellspring", danger: 40, fastTravel: false},
                {id: "AREA_052", name: "Pearl Throne Depths", danger: 41, fastTravel: false},
                {id: "AREA_053", name: "Mirage City", danger: 42, fastTravel: false},
                {id: "AREA_054", name: "Star Dune Pinnacle", danger: 43, fastTravel: false},
                {id: "AREA_055", name: "Fear Incarnate Bog", danger: 44, fastTravel: false},
                {id: "AREA_072", name: "Harmonic Core", danger: 44, fastTravel: false},
                {id: "AREA_032", name: "Divine Battlefield", danger: 45, fastTravel: true},
                {id: "AREA_068", name: "Wind Throne", danger: 45, fastTravel: false},
                {id: "AREA_056", name: "Dream Eater Domain", danger: 46, fastTravel: false},
                {id: "AREA_073", name: "Eternal Phoenix Realm", danger: 46, fastTravel: false},
                {id: "AREA_057", name: "Star Forge", danger: 47, fastTravel: false},
                {id: "AREA_074", name: "Winter Crown Peak", danger: 47, fastTravel: false},
                {id: "AREA_075", name: "Genesis Garden Heart", danger: 48, fastTravel: false},
                {id: "AREA_070", name: "Planar War Command", danger: 48, fastTravel: false},
                {id: "AREA_033", name: "Primordial Chaos", danger: 48, fastTravel: false},
                {id: "AREA_076", name: "Oceanic Throne", danger: 49, fastTravel: false},
                {id: "AREA_071", name: "Universal Court", danger: 49, fastTravel: false},
                {id: "AREA_058", name: "Void Between Stars", danger: 49, fastTravel: false},
                
                // Max Level Areas (50)
                {id: "AREA_063", name: "Absolute Zero", danger: 50, fastTravel: false},
                {id: "AREA_061", name: "Alpha Timeline", danger: 50, fastTravel: false},
                {id: "AREA_065", name: "Apotheosis Chamber", danger: 50, fastTravel: false},
                {id: "AREA_066", name: "Cosmic Library", danger: 50, fastTravel: false},
                {id: "AREA_060", name: "Entropy Maelstrom", danger: 50, fastTravel: false},
                {id: "AREA_059", name: "Genesis Storm", danger: 50, fastTravel: false},
                {id: "AREA_067", name: "Nexus of All", danger: 50, fastTravel: false},
                {id: "AREA_078", name: "Nightmare Nexus", danger: 50, fastTravel: false},
                {id: "AREA_062", name: "Omega Convergence", danger: 50, fastTravel: false},
                {id: "AREA_064", name: "Probability Maze", danger: 50, fastTravel: false},
                {id: "AREA_077", name: "Reality Mirage", danger: 50, fastTravel: false},
                {id: "AREA_079", name: "Stellar Crown Chamber", danger: 50, fastTravel: false},
                {id: "AREA_034", name: "World Tree Crown", danger: 50, fastTravel: false}
            ],
            
            links: [
                // Connections from your data
                {source: "AREA_002", target: "AREA_001"},
                {source: "AREA_002", target: "AREA_005"},
                {source: "AREA_002", target: "AREA_006"},
                {source: "AREA_004", target: "AREA_001"},
                {source: "AREA_004", target: "AREA_009"},
                {source: "AREA_004", target: "AREA_010"},
                {source: "AREA_001", target: "AREA_003"},
                {source: "AREA_003", target: "AREA_007"},
                {source: "AREA_003", target: "AREA_008"},
                {source: "AREA_008", target: "AREA_017"},
                {source: "AREA_008", target: "AREA_018"},
                {source: "AREA_006", target: "AREA_013"},
                {source: "AREA_006", target: "AREA_014"},
                {source: "AREA_012", target: "AREA_005"},
                {source: "AREA_012", target: "AREA_025"},
                {source: "AREA_012", target: "AREA_026"},
                {source: "AREA_080", target: "AREA_003"},
                {source: "AREA_080", target: "AREA_008"},
                {source: "AREA_005", target: "AREA_011"},
                {source: "AREA_010", target: "AREA_021"},
                {source: "AREA_010", target: "AREA_022"},
                {source: "AREA_007", target: "AREA_015"},
                {source: "AREA_007", target: "AREA_016"},
                {source: "AREA_011", target: "AREA_023"},
                {source: "AREA_011", target: "AREA_024"},
                {source: "AREA_084", target: "AREA_010"},
                {source: "AREA_084", target: "AREA_043"},
                {source: "AREA_009", target: "AREA_019"},
                {source: "AREA_009", target: "AREA_020"},
                {source: "AREA_013", target: "AREA_027"},
                {source: "AREA_013", target: "AREA_028"},
                {source: "AREA_014", target: "AREA_029"},
                {source: "AREA_014", target: "AREA_030"},
                {source: "AREA_021", target: "AREA_043"},
                {source: "AREA_021", target: "AREA_044"},
                {source: "AREA_015", target: "AREA_031"},
                {source: "AREA_015", target: "AREA_032"},
                {source: "AREA_018", target: "AREA_037"},
                {source: "AREA_018", target: "AREA_038"},
                {source: "AREA_083", target: "AREA_023"},
                {source: "AREA_083", target: "AREA_038"},
                {source: "AREA_016", target: "AREA_033"},
                {source: "AREA_016", target: "AREA_034"},
                {source: "AREA_022", target: "AREA_045"},
                {source: "AREA_022", target: "AREA_046"},
                {source: "AREA_017", target: "AREA_035"},
                {source: "AREA_017", target: "AREA_036"},
                {source: "AREA_023", target: "AREA_047"},
                {source: "AREA_023", target: "AREA_048"},
                {source: "AREA_025", target: "AREA_051"},
                {source: "AREA_025", target: "AREA_052"},
                {source: "AREA_019", target: "AREA_039"},
                {source: "AREA_019", target: "AREA_040"},
                {source: "AREA_081", target: "AREA_015"},
                {source: "AREA_081", target: "AREA_020"},
                {source: "AREA_082", target: "AREA_026"},
                {source: "AREA_082", target: "AREA_047"},
                {source: "AREA_024", target: "AREA_049"},
                {source: "AREA_024", target: "AREA_050"},
                {source: "AREA_026", target: "AREA_053"},
                {source: "AREA_026", target: "AREA_054"},
                {source: "AREA_020", target: "AREA_041"},
                {source: "AREA_020", target: "AREA_042"},
                {source: "AREA_037", target: "AREA_069"},
                {source: "AREA_085", target: "AREA_049"},
                {source: "AREA_085", target: "AREA_065"},
                {source: "AREA_027", target: "AREA_055"},
                {source: "AREA_027", target: "AREA_056"},
                
                // High level connections
                {source: "AREA_043", target: "AREA_072"},
                {source: "AREA_035", target: "AREA_068"},
                {source: "AREA_038", target: "AREA_069"},
                {source: "AREA_044", target: "AREA_072"},
                {source: "AREA_028", target: "AREA_057"},
                {source: "AREA_028", target: "AREA_058"},
                {source: "AREA_036", target: "AREA_068"},
                {source: "AREA_045", target: "AREA_073"},
                {source: "AREA_039", target: "AREA_070"},
                {source: "AREA_046", target: "AREA_073"},
                {source: "AREA_029", target: "AREA_059"},
                {source: "AREA_029", target: "AREA_060"},
                {source: "AREA_047", target: "AREA_074"},
                {source: "AREA_040", target: "AREA_070"},
                {source: "AREA_048", target: "AREA_074"},
                {source: "AREA_049", target: "AREA_075"},
                {source: "AREA_030", target: "AREA_061"},
                {source: "AREA_030", target: "AREA_062"},
                {source: "AREA_041", target: "AREA_071"},
                {source: "AREA_050", target: "AREA_075"},
                {source: "AREA_042", target: "AREA_071"},
                {source: "AREA_051", target: "AREA_076"},
                {source: "AREA_031", target: "AREA_063"},
                {source: "AREA_031", target: "AREA_064"},
                {source: "AREA_052", target: "AREA_076"},
                {source: "AREA_053", target: "AREA_077"},
                {source: "AREA_054", target: "AREA_077"},
                {source: "AREA_055", target: "AREA_078"},
                {source: "AREA_032", target: "AREA_065"},
                {source: "AREA_032", target: "AREA_066"},
                {source: "AREA_056", target: "AREA_078"},
                {source: "AREA_057", target: "AREA_079"},
                {source: "AREA_058", target: "AREA_079"},
                {source: "AREA_033", target: "AREA_067"},
                {source: "AREA_034", target: "AREA_067"}
            ]
        };

        // Color scale for danger levels
        function getDangerColor(danger) {
            if (danger <= 10) return "#ff6b6b";      // Red
            if (danger <= 20) return "#ffd93d";      // Yellow
            if (danger <= 30) return "#6bcf7f";      // Green
            if (danger <= 40) return "#4d96ff";      // Blue
            return "#9c88ff";                        // Purple
        }

        // Initialize the map
        let svg, g, simulation, nodes, links;
        let width = 1600, height = 800;
        let transform = d3.zoomIdentity;

        function initMap() {
            const container = d3.select("#map-container");
            
            svg = container.append("svg")
                .attr("width", "100%")
                .attr("height", "100%")
                .attr("viewBox", `0 0 ${width} ${height}`)
                .style("background", "transparent");

            // Define zoom behavior
            const zoom = d3.zoom()
                .scaleExtent([0.3, 3])
                .on("zoom", (event) => {
                    transform = event.transform;
                    g.attr("transform", transform);
                });

            svg.call(zoom);

            g = svg.append("g");

            // Create force simulation
            simulation = d3.forceSimulation(worldData.nodes)
                .force("link", d3.forceLink(worldData.links).id(d => d.id).distance(80))
                .force("charge", d3.forceManyBody().strength(-300))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collision", d3.forceCollide().radius(20));

            updateVisualization();
            
            // Update connections count
            document.getElementById('connectionsCount').textContent = worldData.links.length;
        }

        function updateVisualization() {
            // Clear existing elements
            g.selectAll("*").remove();

            const filteredNodes = getFilteredNodes();
            const filteredLinks = worldData.links.filter(link => 
                filteredNodes.some(n => n.id === link.source || n.id === link.source.id) &&
                filteredNodes.some(n => n.id === link.target || n.id === link.target.id)
            );

            // Create links
            const linkElements = g.append("g")
                .selectAll("line")
                .data(filteredLinks)
                .enter().append("line")
                .attr("class", "link");

            // Create nodes
            const nodeElements = g.append("g")
                .selectAll("g")
                .data(filteredNodes)
                .enter().append("g")
                .attr("class", "node")
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            // Node circles
            nodeElements.append("circle")
                .attr("r", d => {
                    const baseSize = parseInt(document.getElementById('nodeSize').value);
                    return d.fastTravel ? baseSize + 4 : baseSize;
                })
                .attr("fill", d => d.fastTravel ? "gold" : getDangerColor(d.danger))
                .attr("stroke", d => d.capital ? "#fff" : (d.fastTravel ? "#fff" : "rgba(255,255,255,0.6)"))
                .attr("stroke-width", d => d.capital ? 4 : (d.fastTravel ? 3 : 2));

            // Node labels
            nodeElements.append("text")
                .attr("class", "node-label")
                .attr("dy", -15)
                .text(d => d.name.length > 15 ? d.name.substring(0, 15) + "..." : d.name)
                .style("font-size", "10px");

            // Danger level badges
            nodeElements.append("text")
                .attr("class", "danger-badge")
                .attr("dy", 4)
                .attr("text-anchor", "middle")
                .text(d => d.danger)
                .style("font-size", "8px")
                .style("fill", "white")
                .style("font-weight", "bold");

            // Event listeners
            nodeElements
                .on("mouseover", function(event, d) {
                    showInfo(d);
                    highlightConnections(d);
                })
                .on("mouseout", function(event, d) {
                    hideInfo();
                    unhighlightConnections();
                })
                .on("click", function(event, d) {
                    focusOnNode(d);
                });

            // Update simulation
            simulation.nodes(filteredNodes);
            simulation.force("link").links(filteredLinks);
            
            // Apply layout
            applyLayout();
            
            simulation.on("tick", () => {
                linkElements
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                nodeElements
                    .attr("transform", d => `translate(${d.x},${d.y})`);
            });

            simulation.alpha(1).restart();
        }

        function getFilteredNodes() {
            const filter = document.getElementById('dangerFilter').value;
            
            switch(filter) {
                case 'low':
                    return worldData.nodes.filter(n => n.danger <= 10);
                case 'mid':
                    return worldData.nodes.filter(n => n.danger > 10 && n.danger <= 30);
                case 'high':
                    return worldData.nodes.filter(n => n.danger > 30);
                default:
                    return worldData.nodes;
            }
        }

        function applyLayout() {
            const layout = document.getElementById('layoutType').value;
            const nodes = simulation.nodes();
            
            if (layout === 'circular') {
                const radius = Math.min(width, height) / 3;
                nodes.forEach((node, i) => {
                    const angle = (i / nodes.length) * 2 * Math.PI;
                    node.fx = width/2 + radius * Math.cos(angle);
                    node.fy = height/2 + radius * Math.sin(angle);
                });
            } else if (layout === 'hierarchical') {
                const maxDanger = Math.max(...nodes.map(n => n.danger));
                nodes.forEach(node => {
                    node.fx = (node.danger / maxDanger) * (width - 200) + 100;
                    node.fy = height/2 + (Math.random() - 0.5) * 400;
                });
            } else {
                // Force layout - remove fixed positions
                nodes.forEach(node => {
                    node.fx = null;
                    node.fy = null;
                });
            }
        }

        function showInfo(node) {
            const panel = document.getElementById('infoPanel');
            const title = document.getElementById('infoTitle');
            const content = document.getElementById('infoContent');
            
            title.textContent = node.name;
            
            let info = `<strong>ID:</strong> ${node.id}<br>`;
            info += `<strong>Danger Level:</strong> ${node.danger}<br>`;
            if (node.fastTravel) info += `<strong>🚀 Fast Travel verfügbar</strong><br>`;
            if (node.capital) info += `<strong>👑 Hauptstadt</strong><br>`;
            
            // Find connections
            const connections = worldData.links
                .filter(link => link.source === node.id || link.target === node.id || 
                               link.source.id === node.id || link.target.id === node.id)
                .map(link => {
                    const targetId = (link.source === node.id || link.source.id === node.id) ? 
                                   (link.target.id || link.target) : (link.source.id || link.source);
                    const targetNode = worldData.nodes.find(n => n.id === targetId);
                    return targetNode ? targetNode.name : targetId;
                });
            
            if (connections.length > 0) {
                info += `<strong>Verbindungen (${connections.length}):</strong><br>`;
                info += connections.slice(0, 5).join(', ');
                if (connections.length > 5) info += `<br>... und ${connections.length - 5} weitere`;
            }
            
            content.innerHTML = info;
            panel.style.display = 'block';
        }

        function hideInfo() {
            document.getElementById('infoPanel').style.display = 'none';
        }

        function highlightConnections(node) {
            g.selectAll(".link")
                .classed("highlighted", d => 
                    d.source === node || d.target === node ||
                    d.source.id === node.id || d.target.id === node.id
                );
        }

        function unhighlightConnections() {
            g.selectAll(".link").classed("highlighted", false);
        }

        function focusOnNode(node) {
            const scale = 1.5;
            const x = -node.x * scale + width / 2;
            const y = -node.y * scale + height / 2;
            
            svg.transition().duration(750).call(
                d3.zoom().transform,
                d3.zoomIdentity.translate(x, y).scale(scale)
            );
        }

        // Zoom functions
        function zoomIn() {
            svg.transition().call(d3.zoom().scaleBy, 1.5);
        }

        function zoomOut() {
            svg.transition().call(d3.zoom().scaleBy, 1 / 1.5);
        }

        function resetZoom() {
            svg.transition().call(d3.zoom().transform, d3.zoomIdentity);
        }

        function centerMap() {
            const bounds = g.node().getBBox();
            const fullWidth = width;
            const fullHeight = height;
            const widthScale = fullWidth / bounds.width;
            const heightScale = fullHeight / bounds.height;
            const scale = Math.min(widthScale, heightScale) * 0.8;
            const x = -bounds.x * scale + (fullWidth - bounds.width * scale) / 2;
            const y = -bounds.y * scale + (fullHeight - bounds.height * scale) / 2;

            svg.transition().duration(750).call(
                d3.zoom().transform,
                d3.zoomIdentity.translate(x, y).scale(scale)
            );
        }

        // Drag functions
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            if (document.getElementById('layoutType').value === 'force') {
                d.fx = null;
                d.fy = null;
            }
        }

        // Event listeners
        document.getElementById('layoutType').addEventListener('change', updateVisualization);
        document.getElementById('dangerFilter').addEventListener('change', updateVisualization);
        document.getElementById('nodeSize').addEventListener('input', updateVisualization);

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initMap);

        // Search functionality
        function searchArea(areaName) {
            const node = worldData.nodes.find(n => 
                n.name.toLowerCase().includes(areaName.toLowerCase()) || 
                n.id.toLowerCase().includes(areaName.toLowerCase())
            );
            
            if (node) {
                focusOnNode(node);
                showInfo(node);
                highlightConnections(node);
                setTimeout(() => {
                    unhighlightConnections();
                    hideInfo();
                }, 3000);
            }
        }

        // Add search functionality to the page
        document.addEventListener('DOMContentLoaded', function() {
            const searchContainer = document.createElement('div');
            searchContainer.className = 'control-group';
            searchContainer.innerHTML = `
                <label>Gebiet suchen:</label>
                <input type="text" id="searchInput" placeholder="z.B. Valoria Capital">
                <button onclick="searchArea(document.getElementById('searchInput').value)">Suchen</button>
            `;
            document.querySelector('.controls').appendChild(searchContainer);
            
            // Enter key search
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchArea(this.value);
                }
            });
        });

        // Export functionality
        function exportMap() {
            const svgData = new XMLSerializer().serializeToString(svg.node());
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            
            const img = new Image();
            img.onload = function() {
                ctx.drawImage(img, 0, 0);
                const link = document.createElement('a');
                link.download = 'galvanur_world_map.png';
                link.href = canvas.toDataURL();
                link.click();
            };
            
            img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
        }

        // Add export button
        document.addEventListener('DOMContentLoaded', function() {
            const exportBtn = document.createElement('button');
            exportBtn.textContent = 'Als PNG exportieren';
            exportBtn.onclick = exportMap;
            exportBtn.style.marginLeft = '10px';
            document.querySelector('.controls .control-group:last-child').appendChild(exportBtn);
        });

        // Statistics update
        function updateStats() {
            const filteredNodes = getFilteredNodes();
            const fastTravelCount = filteredNodes.filter(n => n.fastTravel).length;
            const maxDanger = Math.max(...filteredNodes.map(n => n.danger));
            
            document.querySelectorAll('.stat-number')[0].textContent = filteredNodes.length;
            document.querySelectorAll('.stat-number')[1].textContent = maxDanger;
            document.querySelectorAll('.stat-number')[3].textContent = fastTravelCount;
        }

        // Update stats when filter changes
        document.getElementById('dangerFilter').addEventListener('change', updateStats);
    </script>
</body>
</html>